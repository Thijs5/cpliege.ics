<!DOCTYPE html lang="en">
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <title>cpliege.be.ics</title>
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous"
      />
    </head>
    <body>
      <div class="container">
        <nav class="navbar bg-body-tertiary">
          <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">cpliege.ics</span>
          </div>
        </nav>

        <form class="row g-3 align-items-center" id="clubDivisionForm">
          <div class="col-auto">
            <label for="clubSelect" class="form-label mb-0">Club</label>
            <select class="form-select" id="clubSelect" name="club">
              <option selected disabled>Choose club...</option>
            </select>
          </div>
          <div class="col-auto">
            <label for="divisionSelect" class="form-label mb-0">Division</label>
            <select
              class="form-select"
              id="divisionSelect"
              name="division"
              disabled
            >
              <option selected disabled>Choose division...</option>
            </select>
          </div>
        </form>

        <div id="gamesTableContainer" class="mt-4"></div>

        <script>
const baseApiUrl = 'https://cpliege-ics.netlify.app'

          async function fetchClubs() {
            const res = await fetch(`${baseApiUrl}/api/clubs`);
            const { data } = await res.json();
            const clubSelect = document.getElementById("clubSelect");
            data.forEach((club) => {
              const option = document.createElement("option");
              option.value = club.clubId;
              option.textContent = club.name;
              clubSelect.appendChild(option);
            });
          }

          async function fetchDivisions(clubId) {
            const res = await fetch(`/api/clubs/${clubId}`);
            const { divisions } = await res.json();
            const divisionSelect = document.getElementById("divisionSelect");
            divisionSelect.innerHTML =
              "<option selected disabled>Choose division...</option>";
            divisions.forEach((division, idx) => {
              const option = document.createElement("option");
              option.value = division.name;
              option.textContent = division.name;
              divisionSelect.appendChild(option);
            });
            divisionSelect.disabled = false;

            // Select first division and show games
            if (divisions.length > 0) {
              divisionSelect.value = divisions[0].name;
              showGamesTable(clubId, divisions[0].name, divisions[0].games);
            } else {
              showGamesTable(clubId, "", []);
            }
          }

          async function fetchGames(clubId, divisionName) {
            document.getElementById("gamesTableContainer").innerHTML = "";
            const res = await fetch(`${baseApiUrl}/api/clubs/${encodeURIComponent(clubId)}/${encodeURIComponent(divisionName)}`);
            const { division } = await res.json();
            showGamesTable(clubId, division?.name ?? "", division?.games ?? []);
          }

          function showGamesTable(clubId, divisionName, games) {
            const container = document.getElementById("gamesTableContainer");
            if (!games || games.length === 0) {
              container.innerHTML = divisionName
                ? `<h5>${divisionName}</h5><p>No games found.</p>`
                : "";
              return;
            }
            const calendarUrl = `${baseApiUrl}/api/clubs/${encodeURIComponent(clubId)}/${encodeURIComponent(divisionName)}.ics`;
            const tableHtml = `
              <h5 class="d-flex justify-content-between align-items-center">
                ${divisionName}
              </h5>
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Date & Time</th>
                    <th>Home Team</th>
                    <th>Away Team</th>
                  </tr>
                </thead>
                <tbody>`;
            games.forEach((game) => {
              const dt = game.datetime
                ? new Date(game.datetime).toLocaleString()
                : "";
              tableHtml += `<tr>
                <td class="font-monospace">${game.matchId}</td>
                <td class="font-monospace">
                  <time datetime="${dt}">${dt}</time>
                </td>
                <td>${game.homeTeam}</td>
                <td>${game.awayTeam}</td>
              </tr>`;
            });
            tableHtml += "</tbody></table>";
            container.innerHTML = tableHtml;
          }

          document
            .getElementById("clubSelect")
            .addEventListener("change", function () {
              fetchDivisions(this.value);
            });

          document
            .getElementById("divisionSelect")
            .addEventListener("change", function () {
              const clubId = document.getElementById("clubSelect").value;
              const divisionName = this.value;
              if (clubId && divisionName) {
                fetchGames(clubId, divisionName);
              }
            });
          fetchClubs();
        </script>
      </div>
    </body>
  </html>